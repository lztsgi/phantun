name: Build and Release Phantun

on:
  workflow_dispatch: # 手动触发

permissions:
  contents: write # 必须赋予写权限才能创建 Release

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64
            platform: linux/arm64
          - arch: amd64
            platform: linux/amd64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 1. 动态生成通用 Dockerfile (Alpine)
      # 修改点：去掉了 sleep 3
      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile.alpine
          # === 编译阶段 ===
          FROM rust:alpine AS builder
          WORKDIR /app
          RUN apk add --no-cache musl-dev binutils
          COPY . .
          RUN cargo build --release
          RUN strip target/release/server target/release/client

          # === 运行阶段 ===
          FROM alpine:latest
          RUN apk add --no-cache ca-certificates tzdata

          COPY --from=builder /app/target/release/client /usr/local/bin/phantun-client
          COPY --from=builder /app/target/release/server /usr/local/bin/phantun-server
          
          # 生成通用启动脚本 (无 sleep 版)
          RUN printf '#!/bin/sh\n\
          set -e\n\
          # sleep 3  <-- 已移除\n\
          EXEC_NAME="phantun-server"\n\
          if [ "\$RUN_MODE" = "client" ]; then EXEC_NAME="phantun-client"; fi\n\
          if [ -z "\$LOCAL_ADDR" ]; then echo "Error: LOCAL_ADDR missing"; exit 1; fi\n\
          if [ -z "\$REMOTE_ADDR" ]; then echo "Error: REMOTE_ADDR missing"; exit 1; fi\n\
          ARGS=""\n\
          if [ ! -z "\$TUN_NAME" ]; then ARGS="\$ARGS --tun \$TUN_NAME"; fi\n\
          if [ ! -z "\$TUN_LOCAL" ]; then ARGS="\$ARGS --tun_local \$TUN_LOCAL"; fi\n\
          if [ ! -z "\$TUN_PEER" ]; then ARGS="\$ARGS --tun_peer \$TUN_PEER"; fi\n\
          echo "Starting Phantun (\$EXEC_NAME) on Alpine..."\n\
          exec \$EXEC_NAME --local \$LOCAL_ADDR --remote \$REMOTE_ADDR \$ARGS "\$@"\n' > /usr/local/bin/docker-entrypoint.sh

          RUN chmod +x /usr/local/bin/docker-entrypoint.sh
          ENV RUN_MODE="client" LOCAL_ADDR="" REMOTE_ADDR=""
          ENTRYPOINT ["docker-entrypoint.sh"]
          EOF

      # 2. 构建并加载到 Docker
      - name: Build Image
        run: |
          echo ">>> Building for ${{ matrix.arch }}..."
          docker buildx build --platform ${{ matrix.platform }} \
            --load \
            -f Dockerfile.alpine \
            -t phantun:${{ matrix.arch }} .

      # 3. 导出为兼容 Tar 包
      - name: Save to Tar
        run: |
          FILENAME="phantun-linux-${{ matrix.arch }}.tar"
          docker save -o $FILENAME phantun:${{ matrix.arch }}
          echo "Generated: $FILENAME"

      # 4. 发布到 GitHub Releases
      # 只有手动触发时才会运行此步骤
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }} (${{ github.sha }})
          files: phantun-linux-${{ matrix.arch }}.tar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
