name: Build and Release Phantun

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

# =================================================
# ğŸŸ¢ é…ç½®åŒºåŸŸ (ä¿®æ”¹è¿™é‡Œå³å¯æ”¹å˜ç‰ˆæœ¬å’Œåç§°)
# =================================================
env:
  # è½¯ä»¶åç§° (ç”¨äºæ–‡ä»¶å)
  APP_NAME: "phantun"
  # ç‰ˆæœ¬å· (ç”¨äº Release æ ‡é¢˜å’Œæ–‡ä»¶å)
  APP_VERSION: "0.8.1"
  # å¹³å°å‰ç¼€ (ä¾‹å¦‚ phantun-linux-...)
  FILE_PREFIX: "phantun-linux"
# =================================================

permissions:
  contents: write # å…è®¸åˆ›å»º Release

jobs:
  build:
    # æ˜¾ç¤ºå½“å‰æ„å»ºçš„æ¶æ„
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64
            platform: linux/arm64
          - arch: amd64
            platform: linux/amd64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 1. åŠ¨æ€ç”Ÿæˆé€šç”¨ Dockerfile (Alpine)
      - name: Generate Dockerfile
        run: |
          cat <<EOF > Dockerfile.alpine
          # === ç¼–è¯‘é˜¶æ®µ ===
          FROM rust:alpine AS builder
          WORKDIR /app
          RUN apk add --no-cache musl-dev binutils
          COPY . .
          RUN cargo build --release
          RUN strip target/release/server target/release/client

          # === è¿è¡Œé˜¶æ®µ ===
          FROM alpine:latest
          RUN apk add --no-cache ca-certificates tzdata

          COPY --from=builder /app/target/release/client /usr/local/bin/phantun-client
          COPY --from=builder /app/target/release/server /usr/local/bin/phantun-server
          
          # ç”Ÿæˆé€šç”¨å¯åŠ¨è„šæœ¬ (æ—  sleep ç‰ˆ)
          RUN printf '#!/bin/sh\n\
          set -e\n\
          # sleep 3 (å·²ç§»é™¤)\n\
          EXEC_NAME="phantun-server"\n\
          if [ "\$RUN_MODE" = "client" ]; then EXEC_NAME="phantun-client"; fi\n\
          if [ -z "\$LOCAL_ADDR" ]; then echo "Error: LOCAL_ADDR missing"; exit 1; fi\n\
          if [ -z "\$REMOTE_ADDR" ]; then echo "Error: REMOTE_ADDR missing"; exit 1; fi\n\
          ARGS=""\n\
          if [ ! -z "\$TUN_NAME" ]; then ARGS="\$ARGS --tun \$TUN_NAME"; fi\n\
          if [ ! -z "\$TUN_LOCAL" ]; then ARGS="\$ARGS --tun_local \$TUN_LOCAL"; fi\n\
          if [ ! -z "\$TUN_PEER" ]; then ARGS="\$ARGS --tun_peer \$TUN_PEER"; fi\n\
          echo "Starting Phantun (\$EXEC_NAME) on Alpine..."\n\
          exec \$EXEC_NAME --local \$LOCAL_ADDR --remote \$REMOTE_ADDR \$ARGS "\$@"\n' > /usr/local/bin/docker-entrypoint.sh

          RUN chmod +x /usr/local/bin/docker-entrypoint.sh
          ENV RUN_MODE="client" LOCAL_ADDR="" REMOTE_ADDR=""
          ENTRYPOINT ["docker-entrypoint.sh"]
          EOF

      # 2. æ„å»ºå¹¶åŠ è½½
      - name: Build Image
        run: |
          echo ">>> Building for ${{ matrix.arch }}..."
          docker buildx build --platform ${{ matrix.platform }} \
            --load \
            -f Dockerfile.alpine \
            -t phantun:${{ matrix.arch }} .

      # 3. å¯¼å‡ºä¸º Tar åŒ… (ä½¿ç”¨è‡ªå®šä¹‰å˜é‡å‘½å)
      - name: Save to Tar
        run: |
          # ç»„åˆæ–‡ä»¶å: phantun-linux-0.8.1-arm64.tar
          FILENAME="${{ env.FILE_PREFIX }}-${{ env.APP_VERSION }}-${{ matrix.arch }}.tar"
          
          docker save -o $FILENAME phantun:${{ matrix.arch }}
          echo "Generated: $FILENAME"

      # 4. å‘å¸ƒåˆ° GitHub Releases
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          # Tag æ ¼å¼: v0.8.1-b4 (é˜²æ­¢é‡å¤æ„å»ºæŠ¥é”™)
          tag_name: v${{ env.APP_VERSION }}-b${{ github.run_number }}
          # æ ‡é¢˜æ ¼å¼: Phantun v0.8.1
          name: ${{ env.APP_NAME }} v${{ env.APP_VERSION }}
          # ä¸Šä¼ çš„æ–‡ä»¶åŒ¹é…æ¨¡å¼
          files: ${{ env.FILE_PREFIX }}-${{ env.APP_VERSION }}-${{ matrix.arch }}.tar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
